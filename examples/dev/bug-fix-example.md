# バグ修正チェックリスト

## Bug #456: ログイン後にセッションが即座に切れる問題

::template{id="bug-investigation" src="./templates/bug-fix.md"}

## このバグ固有の調査項目

### 環境固有の調査
- [ ] 本番環境でのみ発生するか確認
- [ ] ブラウザ依存の問題か確認
- [ ] ロードバランサーの設定を確認
- [ ] Redis（セッションストア）の状態を確認

### ログ分析
- [ ] アプリケーションログの確認
- [ ] Nginxアクセスログの確認
- [ ] Redisログの確認
- [ ] システムリソース使用状況の確認

:::result{}
## 調査結果

### バグの詳細
**症状**: ユーザーがログイン後、数秒でセッションが切れて再ログインが必要になる

**発生環境**: 本番環境のみ（ステージング環境では再現しない）

**影響範囲**: 全ユーザー（約1000名）

**発生頻度**: 100%（全てのログインで発生）

### 根本原因
Redisクラスターの設定で、セッションデータが異なるノードに分散保存されているが、
ロードバランサーがスティッキーセッションを使用していないため、
リクエストが別のアプリケーションサーバーに振り分けられた際に
セッション情報を取得できない。

### 修正方針
1. **即座対応**: ロードバランサーでスティッキーセッションを有効化
2. **根本対策**: Redis Clusterでのセッション共有設定を修正
3. **監視強化**: セッション関連のメトリクス監視を追加
:::

---

::template{id="bug-fix-implementation" src="./templates/bug-fix.md"}

## このバグ固有の修正・テスト項目

### インフラ設定修正
- [ ] ロードバランサーのスティッキーセッション設定
- [ ] Redis Clusterの設定見直し
- [ ] セッション共有ライブラリの設定更新

### 監視・アラート追加
- [ ] セッション作成/削除のメトリクス追加
- [ ] Redis接続エラーのアラート設定
- [ ] セッション有効期限のダッシュボード作成

:::result{}
## 修正結果

### 修正実施日
2024年1月25日 14:00-16:00 (メンテナンス時間)

### 修正内容
1. **ロードバランサー設定変更**
   - AWS ALBでスティッキーセッション有効化
   - セッション持続時間: 24時間に設定

2. **Redis設定修正**
   - connect-redis設定でクラスター対応
   - セッションシリアライゼーション方式を統一

3. **アプリケーション修正**
   - セッション管理ミドルウェアの更新
   - エラーハンドリングの強化

### テスト結果
- **単体テスト**: 全て通過 (45/45)
- **結合テスト**: セッション永続化テスト通過
- **負荷テスト**: 1000同時ユーザーで24時間安定動作確認

### 本番環境での動作確認
- ログイン後のセッション維持: ✅ 正常
- 複数タブでの同時アクセス: ✅ 正常  
- ロードバランサー経由のアクセス: ✅ 正常
- セッション有効期限: ✅ 24時間後に正常に切れる

### 監視結果
- セッション作成エラー: 0件
- Redis接続エラー: 0件
- ユーザーからの問い合わせ: 0件

### 事後対応
- [ ] 1週間後の安定性確認
- [ ] 類似問題の予防策検討
- [ ] インシデント報告書の作成
:::